<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Settings Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=block" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="supports-dev-mode">
    <aside>
        <div class="brand-logo" style="cursor: pointer;" onclick="window.location.href='index.html'"><i data-lucide="graduation-cap" width="32" height="32"></i><span>PCG<br>SCHOLAR</span></div>
        <a href="PS_Applications.html" class="nav-item"><i data-lucide="file-text" width="20" height="20"></i>Applications</a>
        <a href="Finances_Invoices.html" class="nav-item"><i data-lucide="dollar-sign" width="20" height="20"></i>Finances</a>
        <a href="#" class="nav-item"><i data-lucide="download-cloud" width="20" height="20"></i>Downloads</a>
        <a href="Admin_Schools.html" class="nav-item active"><i data-lucide="settings" width="20" height="20"></i>Settings</a>
        <a href="index.html" class="nav-item" style="margin-top: 48px;"><i data-lucide="log-out" width="20" height="20"></i>Log out</a>
        <div class="spacer"></div>
        <div class="dev-mode-toggle">
            <label class="switch"><input type="checkbox" id="specModeToggle" onchange="toggleSpecMode(this)"><span class="slider round"></span></label>
            <span class="dev-label">Spec Mode</span>
        </div>
        <div class="ok-logo">OKLAHOMA STATE DEPT<br>OF EDUCATION</div>
    </aside>

    <main>
        <h1 id="pageTitle">Site <strong>Settings</strong></h1>
        <div class="tabs">
            <div class="tab" id="tabUsers">Users</div>
            <div class="tab active" id="tabSchools">Schools</div>
        </div>

        <div>
            <button class="add-btn" id="addSchoolBtn" onclick="window.location.href='Add_School.html'">Add School</button>
        </div>

        <div class="card" id="schoolsCard">
            <div class="search-container">
                <div class="search-box"><i data-lucide="search" class="search-icon"></i><input type="text" id="schoolSearchInput" placeholder="Search"></div>
            </div>

            <div class="table-wrapper">
                <table id="schoolsTable">
                    <thead>
                        <tr><th>School Name</th><th>School Phone</th><th>Contact Name</th><th>Contact Phone</th><th>Contact Email</th><th><span id="activeUsersHeader">Active Users</span></th><th><span id="statusHeader">Status</span></th><th><span id="actionsHeader">Actions</span></th></tr>
                    </thead>
                    <tbody id="schoolsTableBody">
                        </tbody>
                </table>
            </div>

            <div class="pagination">
                <span>Rows per page <select><option>10</option><option>25</option></select></span>
                <span style="margin-left: 20px;">Showing 1-10 of 10 results</span>
                <div class="page-controls"><i data-lucide="chevrons-left" class="control-icon"></i><i data-lucide="chevron-left" class="control-icon"></i><i data-lucide="chevron-right" class="control-icon"></i><i data-lucide="chevrons-right" class="control-icon"></i></div>
            </div>
        </div>
    </main>

    <div class="dropdown-menu" id="menu-dropdown">
        <div class="dropdown-item" onclick="window.location.href='Edit_School.html'">
            <i data-lucide="pencil" class="menu-icon"></i> Edit School
        </div>
        
        <div id="view-users-container"></div>
        
        <div id="dynamic-action-item"></div>
    </div>

    <div class="modal-overlay" id="usersModal">
        <div class="modal-box">
            <div class="modal-header" id="usersModalHeader">
                <h2>Users at <span id="usersSchoolName"></span></h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: #64748B;">Below are the Active user accounts at <span id="usersSchoolNameSub"></span></p>
                <ul class="user-list" id="usersListContainer"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="usersModalCloseBtn" onclick="closeModals()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deactivateModal">
        <div class="modal-box">
            <div class="modal-header" id="deactivateModalHeader"><h2>Deactivate <span id="deactivateSchoolName"></span></h2></div>
            <div class="modal-body">
                <p id="deactivateModalSubtitle">This will mark the school <strong>INACTIVE</strong> (as of <span id="currentDate"></span>).</p>
                <div class="warning-card" id="deactivateWarningCard">
                    <div class="warning-header"><i data-lucide="alert-triangle" width="20" height="20" color="#334155"></i> Outstanding items for this school</div>
                    <div class="warning-grid"><div>• 7 Invoices (2 pending LNH action)</div><div>• 2 Applications (1 pending LNH action)</div><div>• 2 Annual Statements</div></div>
                </div>
                <div class="impact-grid" id="deactivateImpactGrid">
                    <div class="impact-col"><h3>What stops</h3><ul class="impact-list"><li><strong>New applications</strong> (school cannot be selected)</li><li><strong>New annual statements and invoices</strong></li></ul></div>
                    <div class="impact-col"><h3>Users</h3><ul class="impact-list"><li>School users keep access to records</li><li>You must manually deactivate users</li></ul></div>
                </div>
                <div class="impact-col"><h3>What continues</h3><ul class="impact-list"><li>Existing items remain visible</li><li>Draft/Returned items can be edited and resubmitted</li><li>Submitted items can be processed</li></ul></div>
            </div>
            <div class="modal-footer"><button class="btn btn-cancel" id="btnDeactivateCancel" onclick="closeModals()">Cancel</button><button class="btn btn-danger" id="btnDeactivateConfirm" onclick="confirmAction()">Deactivate</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="reactivateModal">
        <div class="modal-box">
            <div class="modal-header" id="reactivateModalHeader"><h2>Reactivate <span id="reactivateSchoolName"></span></h2></div>
            <div class="modal-body">
                <p id="reactivateModalSubtitle">This will mark the school <strong>ACTIVE</strong> (as of <span id="reactivateDate"></span>).</p>
                <div class="impact-grid" id="reactivateImpactGrid" style="margin-top: 24px;">
                    <div class="impact-col"><h3>What starts</h3><ul class="impact-list"><li><strong>New applications</strong> (school can be selected)</li><li><strong>New annual statements and invoices</strong></li></ul></div>
                    <div class="impact-col"><h3>Users</h3><ul class="impact-list"><li>School users keep existing access</li><li>You can enable additional users from the Users page</li></ul></div>
                </div>
                <div class="impact-col"><h3>What continues</h3><ul class="impact-list"><li>Existing items remain available</li><li>Draft/Returned items can be edited and submitted</li><li>Submitted items can be processed</li></ul></div>
            </div>
            <div class="modal-footer"><button class="btn btn-cancel" id="btnReactivateCancel" onclick="closeModals()">Cancel</button><button class="btn btn-primary" id="btnReactivateConfirm" onclick="confirmAction()">Reactivate</button></div>
        </div>
    </div>

    <!-- Spec Slide-out Panel -->
    <div id="specPanel" class="spec-slideout"></div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="history.js"></script>
    <script src="specs.js"></script>
    <script>
        lucide.createIcons();
        
        let currentSchoolId = null;
        
        // Full Data Object with Correct Names
        const schoolsData = [
            {
                id: 1,
                name: "Antioch Christian Academy",
                phone: "(919) 212-4567",
                contact: "Glen Sturgis",
                contactPhone: "(828) 555-1234",
                contactEmail: "gsturgis@gmail.com",
                status: "active",
                users: [
                    { name: "Glen Sturgis", status: "Active", phone: "(828) 555-1234", email: "gsturgis@antioch.edu", login: "3 mins ago" },
                    { name: "Sandra Kaluiokalani", status: "Active", phone: "(828) 555-1235", email: "sandrak@antioch.edu", login: "2 days ago" },
                    { name: "John Doe", status: "Active", phone: "(828) 555-1236", email: "john@antioch.edu", login: "5 mins ago" }
                ]
            },
            {
                id: 2,
                name: "All Saints Catholic School",
                phone: "(405) 555-0199",
                contact: "Jonah Simms",
                contactPhone: "(405) 555-0100",
                contactEmail: "jsimms@allsaints.edu",
                status: "active",
                users: [
                    { name: "Jonah Simms", status: "Active", phone: "(405) 555-0100", email: "jsimms@allsaints.edu", login: "1 hour ago" },
                    { name: "Amy Sosa", status: "Active", phone: "(405) 555-0101", email: "amys@allsaints.edu", login: "Yesterday" }
                ]
            },
            {
                id: 3,
                name: "Artsy Learning Academy",
                phone: "(918) 555-3321",
                contact: "Amy Sosa",
                contactPhone: "(918) 555-3322",
                contactEmail: "asosa@artsy.edu",
                status: "inactive",
                users: [] // No accounts
            },
            {
                id: 4,
                name: "Augustine Christian Academy",
                phone: "(918) 555-9000",
                contact: "Garrett McNeill",
                contactPhone: "(918) 555-9001",
                contactEmail: "gmcneill@aca.edu",
                status: "active",
                users: [
                    { name: "Garrett McNeill", status: "Active", phone: "(918) 555-9001", email: "gmcneill@aca.edu", login: "1 week ago" }
                ]
            },
            {
                id: 5,
                name: "Bishop Kelley High School",
                phone: "(918) 555-8000",
                contact: "Sister Mary Francis",
                contactPhone: "(918) 555-8001",
                contactEmail: "smfrancis@bk.org",
                status: "active",
                users: [
                    { name: "Sister Mary", status: "Active", phone: "(918) 555-8001", email: "smfrancis@bk.org", login: "Just now" },
                    { name: "John Miller", status: "Active", phone: "(918) 555-8002", email: "johnm@bk.org", login: "4 hours ago" }
                ]
            },
            {
                id: 6,
                name: "Cascia Hall Preparatory",
                phone: "(918) 555-6000",
                contact: "Father Philip",
                contactPhone: "(918) 555-6002",
                contactEmail: "fphilip@cascia.org",
                status: "active",
                users: [
                    { name: "Father Philip", status: "Active", phone: "(918) 555-6002", email: "fphilip@cascia.org", login: "12 mins ago" },
                    { name: "Sarah Cassiopeia", status: "Active", phone: "(918) 555-6003", email: "sarahcas@cascia.org", login: "3 days ago" },
                    { name: "Mike Tomlinson", status: "Disabled", phone: "(918) 555-6004", email: "mtomlinson@cascia.org", login: "Never" }
                ]
            },
            {
                id: 7,
                name: "Christian Heritage Academy",
                phone: "(405) 555-4000",
                contact: "David Miller",
                contactPhone: "(405) 555-4001",
                contactEmail: "dmiller@cha.org",
                status: "active",
                users: [
                    { name: "David Miller", status: "Active", phone: "(405) 555-4001", email: "dmiller@cha.org", login: "20 mins ago" }
                ]
            },
            {
                id: 8,
                name: "Community Christian School",
                phone: "(405) 555-2000",
                contact: "Barbara Johnson",
                contactPhone: "(405) 555-2001",
                contactEmail: "bjohnson@ccs.edu",
                status: "inactive",
                users: []
            },
            {
                id: 9,
                name: "Crossings Christian School",
                phone: "(405) 555-1500",
                contact: "Mark Stevens",
                contactPhone: "(405) 555-1501",
                contactEmail: "mstevens@crossings.edu",
                status: "active",
                users: [
                    { name: "Mark Stevens", status: "Active", phone: "(405) 555-1501", email: "mstevens@crossings.edu", login: "2 hours ago" }
                ]
            },
            {
                id: 10,
                name: "Destiny Christian School",
                phone: "(405) 555-7700",
                contact: "Rachel Green",
                contactPhone: "(405) 555-7701",
                contactEmail: "rgreen@destiny.edu",
                status: "active",
                users: [
                    { name: "Rachel Green", status: "Active", phone: "(405) 555-7701", email: "rgreen@destiny.edu", login: "1 min ago" },
                    { name: "Monica Geller", status: "Active", phone: "(405) 555-7702", email: "monicageller@destiny.edu", login: "Yesterday" }
                ]
            }
        ];

        // --- RENDER TABLE ---
        function renderTable(data = schoolsData) {
            // "Rescue" menu before destroying table
            const menu = document.getElementById('menu-dropdown');
            document.body.appendChild(menu);
            menu.style.display = 'none';

            const tbody = document.getElementById('schoolsTableBody');
            tbody.innerHTML = '';

            data.forEach(school => {
                // Determine User Column Text
                let usersText = "No accounts";
                if(school.users.length > 0) {
                    if(school.users.length <= 2) {
                        usersText = school.users.map(u => u.name).join(", ");
                    } else {
                        // Logic: Show first 2 + count of remaining
                        const firstTwo = school.users.slice(0, 2).map(u => u.name).join(", ");
                        const count = school.users.length - 2;
                        usersText = `${firstTwo}, +${count} more`;
                    }
                }

                const statusClass = school.status === 'active' ? 'active' : 'inactive';
                const statusLabel = school.status === 'active' ? 'Active' : 'Inactive';

                const tr = document.createElement('tr');
                tr.setAttribute('data-id', school.id);
                tr.innerHTML = `
                    <td>${school.name}</td>
                    <td><i data-lucide="phone" class="cell-icon"></i> ${school.phone}</td>
                    <td>${school.contact}</td>
                    <td><i data-lucide="phone" class="cell-icon"></i> ${school.contactPhone}</td>
                    <td><i data-lucide="mail" class="cell-icon"></i> ${school.contactEmail}</td>
                    <td>${usersText}</td>
                    <td><span class="status ${statusClass}">${statusLabel}</span></td>
                    <td class="action-cell">
                        <button class="action-btn" onclick="toggleMenu(event, this, ${school.id})">
                            <i data-lucide="more-vertical" width="18" height="18"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- MENU LOGIC ---
        function toggleMenu(event, button, schoolId) {
            event.stopPropagation();
            currentSchoolId = schoolId;
            
            const school = schoolsData.find(s => s.id === schoolId);
            const reusableMenu = document.getElementById('menu-dropdown');
            const userContainer = document.getElementById('view-users-container');
            const dynamicItem = document.getElementById('dynamic-action-item');
            
            // 1. Configure "View Users" button state
            if(school.users.length === 0) {
                userContainer.innerHTML = `
                    <div class="dropdown-item disabled">
                        <i data-lucide="eye" class="menu-icon"></i> View Users
                    </div>`;
            } else {
                userContainer.innerHTML = `
                    <div class="dropdown-item" onclick="openUsersModal(${schoolId})">
                        <i data-lucide="eye" class="menu-icon"></i> View Users
                    </div>`;
            }

            // 2. Configure Action Button (Deactivate/Reactivate)
            if(school.status === 'active') {
                dynamicItem.innerHTML = `
                    <div class="dropdown-item danger" onclick="openDeactivateModal('${school.name}')">
                        <i data-lucide="power" class="menu-icon"></i> Deactivate School
                    </div>`;
            } else {
                dynamicItem.innerHTML = `
                    <div class="dropdown-item" onclick="openReactivateModal('${school.name}')" style="color:var(--status-active-text)">
                        <i data-lucide="power" class="menu-icon" style="color:var(--status-active-text)"></i> Reactivate School
                    </div>`;
            }
            
            lucide.createIcons();

            // 3. Position and Toggle Menu
            const allBtns = document.querySelectorAll('.action-btn');
            
            if (reusableMenu.style.display === 'block' && reusableMenu.parentElement === button.parentElement) {
                reusableMenu.style.display = 'none';
                button.classList.remove('active');
            } else {
                button.parentElement.appendChild(reusableMenu);
                allBtns.forEach(btn => btn.classList.remove('active'));
                reusableMenu.style.display = 'block';
                button.classList.add('active');
            }
        }

        // --- MODAL LOGIC ---
        function openUsersModal(schoolId) {
            const school = schoolsData.find(s => s.id === schoolId);
            document.getElementById('usersSchoolName').innerText = school.name;
            document.getElementById('usersSchoolNameSub').innerText = school.name;
            
            const listContainer = document.getElementById('usersListContainer');
            listContainer.innerHTML = '';
            
            school.users.forEach(user => {
                const statusClass = user.status === 'Active' ? 'active' : 'inactive';
                const statusStyle = user.status === 'Disabled' ? 'disabled' : '';
                const badgeClass = user.status === 'Disabled' ? 'disabled' : statusClass;
                
                const item = document.createElement('li');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-header">
                            <span class="user-name">${user.name}</span>
                            <span class="user-badge ${badgeClass}">${user.status}</span>
                        </div>
                        <div class="user-meta">
                            <a href="#" class="meta-item"><i data-lucide="phone" class="meta-icon"></i> ${user.phone}</a>
                            <a href="#" class="meta-item"><i data-lucide="mail" class="meta-icon"></i> ${user.email}</a>
                        </div>
                    </div>
                    <div class="user-login">
                        Last login: <strong>${user.login}</strong>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
            
            document.getElementById('usersModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';

            if (document.body.classList.contains('spec-mode')) {
                renderSpecMarkers('admin_schools_users_modal');
                renderSpecPanel('admin_schools_users_modal');
            }
        }

        function getFormattedDate() {
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            return new Date().toLocaleDateString('en-US', dateOptions);
        }

        function openDeactivateModal(name) {
            document.getElementById('currentDate').innerText = getFormattedDate();
            document.getElementById('deactivateSchoolName').innerText = name;
            document.getElementById('deactivateModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';

            if (document.body.classList.contains('spec-mode')) {
                renderSpecMarkers('admin_schools_deactivate_modal');
                renderSpecPanel('admin_schools_deactivate_modal');
            }
        }

        function openReactivateModal(name) {
            document.getElementById('reactivateDate').innerText = getFormattedDate();
            document.getElementById('reactivateSchoolName').innerText = name;
            document.getElementById('reactivateModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';

            if (document.body.classList.contains('spec-mode')) {
                requestAnimationFrame(() => {
                    renderSpecMarkers('admin_schools_reactivate_modal');
                    renderSpecPanel('admin_schools_reactivate_modal');
                });
            }    
        }

        function closeModals() {
            document.getElementById('deactivateModal').classList.remove('show');
            document.getElementById('reactivateModal').classList.remove('show');
            document.getElementById('usersModal').classList.remove('show');

            if (document.body.classList.contains('spec-mode')) {
                renderSpecMarkers('admin_schools');
                renderSpecPanel('admin_schools');
            }
        }

        function confirmAction() {
            closeModals();
            // Update Data Model
            const school = schoolsData.find(s => s.id === currentSchoolId);
            if(school) {
                school.status = school.status === 'active' ? 'inactive' : 'active';
                renderTable(); // Re-render table to show new status
            }
        }

        // Global Listeners
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('menu-dropdown');
            const isClickInsideMenu = menu.contains(event.target);
            const isClickOnButton = event.target.closest('.action-btn');
            if (!isClickInsideMenu && !isClickOnButton) {
                menu.style.display = 'none';
                document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
            }
        });

        // Initialize Table
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();

            // Search Listener
            document.getElementById('schoolSearchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = schoolsData.filter(s => s.name.toLowerCase().includes(term));
                renderTable(filtered);
            });
        });

    </script>

    <!-- Dev History Component -->
    <div class="dev-history-trigger" onclick="document.getElementById('devHistoryPanel').classList.toggle('show')">
        <i data-lucide="history" width="24" height="24"></i>
    </div>
    <div class="dev-history-panel" id="devHistoryPanel">
        <div class="dev-history-header">
            Page Revision History
            <i data-lucide="x" width="16" height="16" style="cursor:pointer;" onclick="document.getElementById('devHistoryPanel').classList.remove('show')"></i>
        </div>
        <ul class="dev-history-list" id="historyList"></ul>
    </div>
    <script src="history.js"></script>
    <script>
        const list = document.getElementById('historyList');
        if (window.projectHistory && window.projectHistory['admin-schools'] && list) {
            window.projectHistory['admin-schools'].forEach(item => {
                const li = document.createElement('li');
                li.className = 'dev-history-item';
                li.innerHTML = `<div class="dev-history-meta"><span class="dev-history-date">${item.date}</span><span class="dev-history-ticket">${item.ticket}</span></div><span class="dev-history-note">${item.note}</span>`;
                list.appendChild(li);
            });
        }
    </script>
    <script>
        // --- SPEC MODE LOGIC ---
        function toggleSpecMode(checkbox) {
            const isSpec = checkbox.checked;
            if (isSpec) {
                document.body.classList.add('spec-mode');
                renderSpecMarkers();
                renderSpecPanel();
            } else {
                document.body.classList.remove('spec-mode');
                removeSpecMarkers();
                toggleSpecPanel(false);
            }
            localStorage.setItem('specMode', isSpec);
        }

        function getCurrentSpecKey() {
            const usersModal = document.getElementById('usersModal');
            if (usersModal && usersModal.classList.contains('show')) {
                return 'admin_schools_users_modal';
            }
            const deactivateModal = document.getElementById('deactivateModal');
            if (deactivateModal && deactivateModal.classList.contains('show')) {
                return 'admin_schools_deactivate_modal';
            }
            const reactivateModal = document.getElementById('reactivateModal');
            if (reactivateModal && reactivateModal.classList.contains('show')) {
                return 'admin_schools_reactivate_modal';
            }
            return 'admin_schools';
        }

        function renderSpecMarkers(overrideKey) {
            removeSpecMarkers(); // Clear existing
            if (!document.body.classList.contains('spec-mode')) return;
            
            const specKey = overrideKey || getCurrentSpecKey();
            if (!window.PAGE_SPECS || !window.PAGE_SPECS[specKey]) return;

            const specs = window.PAGE_SPECS[specKey];
            const main = document.querySelector('main');
            const mainRect = main.getBoundingClientRect();
            const isModal = specKey.includes('_modal');
            const container = isModal ? document.body : main;
            let specCount = 0;

            specs.forEach((spec, index) => {
                const target = document.getElementById(spec.targetId);
                if (target) {
                    const rect = target.getBoundingClientRect();
                    const marker = document.createElement('div');
                    marker.className = 'spec-marker';
                    
                    if (spec.specialMarker === 'purple-star') {
                        marker.classList.add('purple-star');
                        marker.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                    } else {
                        specCount++;
                        marker.innerText = specCount;
                    }
                    
                    // Base Positioning Logic
                    let baseTop, baseLeft;

                    if (spec.type === 'Table Column') {
                        baseTop = rect.top + (rect.height / 2) - 14;
                        baseLeft = rect.left;
                    } else {
                        baseTop = rect.top - 14;
                        baseLeft = rect.right - 14;
                    }

                    // Calculate position based on container
                    let top, left;
                    if (isModal) {
                        // Fixed positioning for modals (relative to viewport/body)
                        top = baseTop + window.scrollY;
                        left = baseLeft + window.scrollX;
                    } else {
                        // Relative positioning for scrolling main content
                        top = baseTop - mainRect.top + main.scrollTop;
                        left = baseLeft - mainRect.left + main.scrollLeft;
                    }

                    let topOffset = '', leftOffset = '';
                    if (spec.offset) {
                        if (spec.offset.top) topOffset += ` + ${spec.offset.top}`;
                        if (spec.offset.bottom) topOffset += ` - ${spec.offset.bottom}`;
                        if (spec.offset.left) leftOffset += ` + ${spec.offset.left}`;
                        if (spec.offset.right) leftOffset += ` - ${spec.offset.right}`;
                    }
                    
                    marker.style.top = `calc(${top}px${topOffset})`;
                    marker.style.left = `calc(${left}px${leftOffset})`;
                    
                    marker.onclick = (e) => {
                        e.stopPropagation();
                        scrollToSpec(index + 1);
                    };
                    container.appendChild(marker);
                }
            });
        }

        function removeSpecMarkers() {
            document.querySelectorAll('.spec-marker').forEach(el => el.remove());
        }

        function renderSpecPanel(overrideKey) {
            const panel = document.getElementById('specPanel');
            
            const specKey = overrideKey || getCurrentSpecKey();
            if (!window.PAGE_SPECS || !window.PAGE_SPECS[specKey]) return;
            const specs = window.PAGE_SPECS[specKey];

            let html = `
                <div class="spec-panel-header">
                    <h3>Page Specifications (${specs.length})</h3>
                    <i data-lucide="x" class="spec-close-btn" onclick="toggleSpecPanel(false)"></i>
                </div>
                <div class="spec-content-wrapper">
            `;

            let specCount = 0;

            specs.forEach((data, index) => {
                const num = index + 1;
                
                // Custom History Content
                let customContent = '';
                if (data.specialMarker === 'purple-star' && window.projectHistory && window.projectHistory['admin-schools']) {
                    const history = window.projectHistory['admin-schools'];
                    customContent = `<div class="spec-section"><span class="spec-label">Revision History</span><div class="spec-text">`;
                    history.forEach(h => {
                        customContent += `<div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="font-weight:700; font-size:12px; color:#111827;">${h.date}</span>
                                <span style="font-family:monospace; background:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:11px; color:#6B7280;">${h.ticket}</span>
                            </div>
                            <div style="font-size:13px; color:#374151; line-height:1.4;">${h.note}</div>
                        </div>`;
                    });
                    customContent += `</div></div>`;
                }

                const createSection = (label, text) => text ? `<div class="spec-section"><span class="spec-label">${label}</span><div class="spec-text">${text}</div></div>` : '';
                
                // Conditional Title and Type
                let displayTitle;
                if (data.specialMarker) {
                    displayTitle = data.title;
                } else {
                    specCount++;
                    displayTitle = `<span class="spec-number">${specCount}</span>${data.title}`;
                }
                const displayType = data.type ? `<span class="spec-type">${data.type}</span>` : '';

                html += `
                    <div id="spec-item-${num}" class="spec-item" onclick="scrollToSpec(${num})">
                        <div class="spec-item-header">
                            <h3 style="margin:0; font-size:14px; font-weight:700; color:#111827; display:flex; align-items:center;">${displayTitle}</h3>
                            ${displayType}
                        </div>
                        <div class="spec-item-body">
                            <div class="spec-section"><span class="spec-label">Target ID</span><span class="code-snippet">${data.targetId}</span></div>
                            ${customContent}
                            ${createSection("Description", data.description)}
                            ${createSection("Logic & Validation", data.logic)}
                            ${createSection("Default State", data.defaults)}
                            ${createSection("Interaction", data.interaction)}
                            ${data.errors && data.errors.length > 0 ? `
                                <div class="spec-section">
                                    <span class="spec-label" style="color:#ef4444;">Error Messages</span>
                                    <div class="spec-errors">
                                        ${data.errors.map(err => `<div class="error-item"><span class="error-condition">${err.condition}:</span><span class="error-text">"${err.text}"</span></div>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            panel.innerHTML = html;
            lucide.createIcons();
        }

        function toggleSpecPanel(show) {
            const panel = document.getElementById('specPanel');
            if (show) {
                panel.classList.add('open');
                document.body.classList.add('spec-panel-open');
            } else {
                panel.classList.remove('open');
                document.body.classList.remove('spec-panel-open');
            }
            // Re-render markers after transition to ensure alignment
            setTimeout(renderSpecMarkers, 300); 
        }

        function scrollToSpec(index) {
            const panel = document.getElementById('specPanel');
            if (!panel.classList.contains('open')) {
                toggleSpecPanel(true);
            }
            
            // Remove active class from all
            panel.querySelectorAll('.spec-item').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(`spec-item-${index}`);
            if (target) {
                target.classList.add('active');
                
                // Manual scroll to handle sticky header offset reliably
                const headerOffset = 90;
                const targetPos = target.offsetTop - headerOffset;
                smoothScrollTo(panel, targetPos, 1000); // 1000ms for slower, inertia-like scroll
            }
        }

        function smoothScrollTo(element, target, duration) {
            const start = element.scrollTop;
            const change = target - start;
            const startTime = performance.now();

            function animateScroll(currentTime) {
                const elapsed = currentTime - startTime;
                if (elapsed < duration) {
                    // Ease Out Quart (1 - (1-t)^4) for strong inertia feel
                    const t = elapsed / duration;
                    const ease = 1 - Math.pow(1 - t, 4);
                    
                    element.scrollTop = start + (change * ease);
                    requestAnimationFrame(animateScroll);
                } else {
                    element.scrollTop = target;
                }
            }
            requestAnimationFrame(animateScroll);
        }

        // Handle Resize to reposition markers
        window.addEventListener('resize', () => {
            if(document.body.classList.contains('spec-mode')) renderSpecMarkers();
        });

        // Handle transition end to ensure markers are perfectly placed
        document.body.addEventListener('transitionend', (e) => {
            if (e.propertyName === 'padding-right' && document.body.classList.contains('spec-mode')) {
                renderSpecMarkers();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const isSpec = localStorage.getItem('specMode') === 'true';
            const toggle = document.getElementById('specModeToggle');
            if(toggle) {
                toggle.checked = isSpec;
                if(isSpec) toggleSpecMode(toggle);
            }
        });
    </script>
</body>
</html>